# 기능 명세서: 프리미엄 콘텐츠 보호 시스템

**작성일**: 2025-11-15
**상태**: 초안
**우선순위**: 중요 (출시 전 필수)
**관련 헌장 원칙**: 원칙 1 (프리미엄 콘텐츠 보호)

## 개요

### 목적
유료 구독자만 프리미엄 콘텐츠에 접근할 수 있도록 하는 접근 제어 시스템을 구현합니다. 이는 CryptoTitan 블로그의 핵심 수익화 모델을 가능하게 하는 필수 기능입니다.

### 배경
현재 프리미엄으로 표시된 게시글(`isPremium: true`)이 기술적 보호 없이 모든 사용자에게 노출되어 있습니다. 이는 구독의 가치를 무효화하고 수익 모델을 완전히 무력화합니다.

### 범위

**포함사항:**
- 프리미엄 게시글 접근 시 구독 상태 실시간 검증
- 비구독자에게 프리미엄 콘텐츠 미리보기/발췌문 차단
- Stripe 웹훅을 통한 구독 상태 실시간 동기화
- 구독 만료/취소 시 즉시 접근 차단
- 프리미엄 게시글 목록에서 잠금 표시

**제외사항:**
- 결제 처리 (이미 Stripe로 구현됨)
- 사용자 인증 (별도 기능으로 분리)
- 콘텐츠 작성/관리 (Sanity CMS에서 처리)
- 구독 플랜 변경 UI (향후 기능)

## 사용자 시나리오

### 시나리오 1: 비구독자가 프리미엄 게시글 접근 시도

**사용자**: 로그인하지 않은 방문자
**상황**: 홈페이지에서 프리미엄 마크(⭐)가 있는 게시글 클릭

1. 사용자가 프리미엄 게시글 링크 클릭
2. 시스템이 사용자 인증 상태 확인
3. 미인증 사용자이므로 로그인 페이지로 리다이렉트
4. 로그인 후 원래 게시글 URL로 자동 이동
5. 구독 상태 확인 → 비구독자
6. 페이월 화면 표시:
   - 게시글 제목과 발췌문 일부 (최대 2문장)
   - "이 콘텐츠는 프리미엄 구독자 전용입니다" 메시지
   - 구독 혜택 요약
   - "프리미엄 구독하기" CTA 버튼
7. CTA 클릭 시 구독 페이지로 이동

### 시나리오 2: 활성 구독자가 프리미엄 게시글 접근

**사용자**: 월간/연간 구독 중인 로그인 사용자
**상황**: 프리미엄 게시글 클릭

1. 사용자가 프리미엄 게시글 링크 클릭
2. 시스템이 사용자 인증 상태 확인 → 인증됨
3. Supabase에서 구독 상태 조회:
   - `subscriptions` 테이블에서 `user_id`로 검색
   - `status`가 'active' 또는 'trialing'인지 확인
   - `current_period_end`가 현재 시각 이후인지 확인
4. 모든 조건 만족 시 전체 게시글 렌더링
5. 사용자가 전체 콘텐츠 읽기 가능

### 시나리오 3: 구독 만료된 사용자 접근 시도

**사용자**: 과거 구독자 (현재 만료)
**상황**: 프리미엄 게시글 접근

1. 사용자가 프리미엄 게시글 링크 클릭
2. 시스템이 구독 상태 확인
3. `current_period_end`가 과거 시각 → 만료됨
4. 페이월 화면 표시:
   - "구독이 만료되었습니다" 메시지
   - "계속 읽으려면 구독을 갱신하세요" 안내
   - "구독 갱신하기" CTA 버튼

### 시나리오 4: 구독 결제 완료 후 즉시 접근

**사용자**: 방금 구독 결제 완료한 사용자
**상황**: 결제 성공 후 프리미엄 콘텐츠 접근

1. Stripe Checkout 세션 완료
2. Stripe 웹훅(`checkout.session.completed`) 수신
3. Supabase `subscriptions` 테이블에 레코드 생성:
   - `user_id`, `stripe_subscription_id`, `status='active'`, `current_period_end` 저장
4. 사용자가 "구독 성공" 페이지에서 프리미엄 게시글로 이동
5. 구독 상태 확인 → 활성화됨
6. 전체 콘텐츠 즉시 접근 가능

## 기능 요구사항

### FR1: 프리미엄 게시글 접근 제어
- **설명**: 사용자가 프리미엄 게시글(`isPremium: true`) 접근 시 구독 상태를 서버 측에서 검증해야 함
- **조건**:
  - 검증은 페이지 렌더링 전에 완료되어야 함
  - 클라이언트 측 검증만으로는 불충분 (우회 가능)
  - API 응답에서도 프리미엄 콘텐츠 본문을 노출하지 않아야 함
- **예외**: 무료 게시글(`isPremium: false`)은 검증 생략

### FR2: 구독 상태 실시간 동기화
- **설명**: Stripe 웹훅 이벤트 수신 시 Supabase 구독 상태를 즉시 업데이트해야 함
- **지원 이벤트**:
  - `checkout.session.completed`: 신규 구독 생성
  - `customer.subscription.updated`: 구독 상태 변경 (업그레이드/다운그레이드)
  - `customer.subscription.deleted`: 구독 취소
- **조건**:
  - 웹훅 수신부터 DB 업데이트까지 5초 이내 완료
  - 실패 시 재시도 로직 (최대 3회)

### FR3: 페이월 UI 표시
- **설명**: 비구독자가 프리미엄 게시글 접근 시 페이월 화면을 표시해야 함
- **표시 내용**:
  - 게시글 제목 (전체)
  - 발췌문 첫 2문장 또는 150자 (둘 중 짧은 것)
  - 커버 이미지 (있는 경우)
  - "프리미엄 구독자 전용" 명확한 메시지
  - 구독 혜택 요약 (최대 3개 항목)
  - "프리미엄 구독하기" CTA 버튼
- **조건**:
  - 본문 콘텐츠는 절대 노출 금지
  - SEO를 위한 메타 태그는 허용 (단, `<meta name="robots" content="noindex">` 추가)

### FR4: 프리미엄 콘텐츠 미리보기 방지
- **설명**: API 응답에서 프리미엄 콘텐츠가 유출되지 않도록 해야 함
- **적용 범위**:
  - `/api/posts` 목록 API: `content` 필드 제거, `excerpt`만 제공
  - `/api/posts/[slug]` 상세 API: 비구독자에게 `content` null 반환
  - GraphQL/GROQ 쿼리: 조건부 필드 제외
- **조건**:
  - 무료 게시글은 전체 노출
  - 프리미엄 게시글의 메타데이터(제목, 작성자, 날짜, 태그)는 노출 허용

### FR5: 구독 상태 캐싱
- **설명**: 동일 사용자의 구독 상태를 단기 캐싱하여 DB 부하 감소
- **캐싱 전략**:
  - 세션 기반 캐싱 (NextAuth 세션 객체에 `isPremium` 추가)
  - TTL: 5분
  - 웹훅 수신 시 해당 사용자 캐시 무효화
- **조건**:
  - 캐시 미스 시 항상 DB 조회로 폴백
  - 구독 만료 시각(`current_period_end`) 체크는 매번 수행

## 비기능 요구사항

### NFR1: 성능
- 구독 상태 검증은 100ms 이내 완료되어야 함 (95th percentile)
- 프리미엄 게시글 페이지 로드 시간은 비프리미엄 대비 200ms 이상 증가하지 않아야 함

### NFR2: 보안
- 구독 상태 검증은 서버 측에서만 수행 (클라이언트 우회 불가)
- API 응답에 민감한 구독 정보(Stripe Customer ID, 결제 수단) 노출 금지
- 웹훅 서명 검증 필수 (Stripe webhook secret)

### NFR3: 신뢰성
- Stripe 웹훅 처리 성공률 99.9% 이상
- 웹훅 실패 시 재시도 메커니즘 (지수 백오프)
- 구독 상태 불일치 시 수동 복구 프로세스 문서화

### NFR4: 사용성
- 페이월 메시지는 명확하고 간결해야 함 (전문 용어 지양)
- 구독 CTA는 2번의 클릭 이내에 결제 페이지 도달
- 모바일에서도 페이월 UI가 명확하게 표시되어야 함

## 성공 기준

### 정량적 지표
1. **보호 효과**: 비구독자의 프리미엄 콘텐츠 본문 접근율 0%
2. **동기화 속도**: 웹훅 수신부터 구독 상태 반영까지 평균 3초 이내
3. **전환율**: 페이월 노출 대비 구독 페이지 이동율 15% 이상
4. **성능**: 구독 검증으로 인한 페이지 로드 시간 증가 150ms 이하

### 정성적 지표
1. 구독자가 프리미엄 콘텐츠에 즉시 접근 가능 (구독 후 5초 이내)
2. 비구독자에게 구독 가치가 명확하게 전달됨 (페이월 메시지 통해)
3. 구독 만료 시 우아한 안내 메시지 (강압적이지 않음)

## 주요 엔티티

### Subscription (Supabase)
```
subscriptions
├── id (uuid, PK)
├── user_id (uuid, FK → profiles)
├── stripe_subscription_id (text, unique)
├── stripe_customer_id (text)
├── status (text) -- 'active', 'canceled', 'past_due', 'trialing'
├── plan (text) -- 'monthly', 'yearly'
├── current_period_end (timestamptz)
├── cancel_at_period_end (boolean)
├── created_at (timestamptz)
└── updated_at (timestamptz)
```

### Post (Sanity CMS)
```
post
├── _id
├── slug
├── title
├── content (array of blocks)
├── excerpt (text)
├── isPremium (boolean) ← 접근 제어 기준
├── coverImage
├── author (reference)
└── publishedAt
```

## 테스트 시나리오

### 수용 테스트 1: 비구독자 차단
1. 로그인하지 않은 상태에서 프리미엄 게시글 URL 직접 접근
2. **기대 결과**: 로그인 페이지로 리다이렉트
3. 로그인 후 (비구독 계정)
4. **기대 결과**: 페이월 화면 표시, 본문 콘텐츠 없음

### 수용 테스트 2: 구독자 접근 허용
1. 활성 구독이 있는 계정으로 로그인
2. 프리미엄 게시글 접근
3. **기대 결과**: 전체 콘텐츠 즉시 표시

### 수용 테스트 3: 구독 만료 처리
1. 구독 만료일이 어제인 계정으로 로그인
2. 프리미엄 게시글 접근
3. **기대 결과**: "구독이 만료되었습니다" 메시지와 갱신 CTA

### 수용 테스트 4: 실시간 동기화
1. Stripe 테스트 모드에서 신규 구독 생성
2. Checkout 완료 즉시 프리미엄 게시글 접근
3. **기대 결과**: 5초 이내에 전체 콘텐츠 접근 가능

### 수용 테스트 5: API 보호
1. 비구독 계정의 JWT 토큰으로 `/api/posts/[premium-slug]` 호출
2. **기대 결과**: `content` 필드가 null 또는 제외됨
3. 응답 본문에 실제 콘텐츠 포함되지 않음

## 엣지 케이스

### EC1: 웹훅 지연
- **상황**: Stripe 웹훅이 30초 이상 지연되는 경우
- **처리**: 사용자에게 "구독 처리 중입니다. 잠시 후 다시 시도해주세요" 메시지 표시
- **복구**: 재시도 버튼 제공, 1분 후에도 미반영 시 고객센터 안내

### EC2: 구독 상태 불일치
- **상황**: Stripe에서는 활성이지만 Supabase에는 없는 경우
- **처리**: Stripe API로 직접 구독 상태 조회 (폴백)
- **복구**: 수동 동기화 스크립트 제공 (관리자 도구)

### EC3: 무료 체험 종료
- **상황**: 7일 무료 체험(`trialing`) 종료 시
- **처리**: 첫 결제 실패 시 `status='past_due'` → 3일 유예 기간
- **복구**: 유예 기간 중 매일 결제 재시도, 3일 후 `canceled` 전환

### EC4: 동시 접근
- **상황**: 동일 사용자가 여러 탭에서 프리미엄 게시글 동시 접근
- **처리**: 각 탭이 독립적으로 구독 상태 검증 (캐시 공유)
- **복구**: 캐시 일관성 유지 (세션 기반)

### EC5: 구독 다운그레이드
- **상황**: 연간 → 월간 플랜 변경
- **처리**: 현재 기간 종료까지 연간 혜택 유지, 이후 월간 적용
- **복구**: `cancel_at_period_end=false`, `plan` 필드만 업데이트

## 가정사항

1. **Stripe 웹훅 안정성**: Stripe 웹훅이 99.9% 성공률로 전달된다고 가정
2. **사용자 행동**: 대부분의 사용자는 정상적인 경로로 접근 (직접 URL 조작 최소)
3. **구독 플랜**: 월간/연간 2가지 플랜만 존재 (향후 확장 가능)
4. **동시 구독**: 한 사용자당 하나의 활성 구독만 가능
5. **세션 유효성**: NextAuth 세션이 유효한 동안 사용자 인증 상태 신뢰 가능

## 종속성

### 외부 종속성
- **Stripe API**: 구독 상태 조회 및 웹훅 수신
- **Supabase**: 구독 데이터 저장 및 조회
- **NextAuth**: 사용자 인증 상태 확인

### 내부 종속성
- **인증 시스템** (기능 2): 로그인 페이지 및 세션 관리 필요
- **Sanity CMS**: `isPremium` 필드 정확히 설정되어야 함
- **Stripe 통합** (이미 구현됨): 웹훅 엔드포인트 작동 필요

## 제약사항

### 기술 제약
- Next.js 14 App Router 사용 (Middleware 활용)
- Supabase Row Level Security (RLS) 정책 적용 불가 (구독 로직이 복잡)
- 서버 측 검증 필수 (클라이언트 JS 비활성화 시에도 보호)

### 비즈니스 제약
- 구독 취소 시 현재 기간 종료까지 접근 유지 (환불 없음)
- 무료 체험 기간 중에도 전체 프리미엄 콘텐츠 접근 가능
- 구독 가격 변경 시 기존 구독자는 기존 가격 유지 (Stripe 정책)

## 위험 요소

### 높은 위험
- **웹훅 실패**: Stripe 웹훅이 누락되면 구독 상태 불일치 발생
  - **완화**: 재시도 로직 + 수동 동기화 도구
- **캐시 불일치**: 세션 캐시와 DB 상태가 달라 비구독자가 접근 가능
  - **완화**: TTL 짧게 유지 (5분), 웹훅 시 즉시 무효화

### 중간 위험
- **성능 저하**: 모든 프리미엄 게시글 접근마다 DB 조회 시 부하 증가
  - **완화**: 세션 캐싱 + Supabase 인덱스 최적화
- **사용자 혼란**: 페이월 메시지가 불명확하면 구독 전환율 하락
  - **완화**: A/B 테스팅으로 최적 문구 찾기

## 구현 접근 방식 (참고용)

> **주의**: 아래 내용은 기술팀 참고용이며, 명세서의 핵심은 위의 요구사항입니다.

**권장 아키텍처**:
1. Next.js Middleware에서 `/blog/[slug]` 경로 인터셉트
2. 세션에서 `user.id` 추출 → Supabase에서 구독 조회
3. 구독 없으면 `/premium-paywall/[slug]` 페이지로 리라이트
4. 구독 있으면 정상 렌더링

**대안**:
- 페이지 컴포넌트에서 `getServerSideProps`로 검증 (더 느림)
- API Route에서 보호 (API만 보호, 직접 접근 차단 못함)

## 관련 문서

- [CryptoTitan 헌장 - 원칙 1](../../memory/constitution.md#원칙-1-프리미엄-콘텐츠-보호)
- [Stripe 웹훅 문서](https://stripe.com/docs/webhooks)
- [Supabase RLS 가이드](https://supabase.com/docs/guides/auth/row-level-security)

---

**다음 단계**: 이 명세서를 `/speckit.clarify`로 검토하여 불명확한 부분을 명확히 한 후, `/speckit.plan`으로 구현 계획 수립
