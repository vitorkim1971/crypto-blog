# 기능 명세서: 인증 시스템 완성

**작성일**: 2025-11-15
**상태**: 초안
**우선순위**: 중요 (출시 전 필수)
**관련 헌장 원칙**: 원칙 6 (보안 및 개인정보 보호)

## 개요

### 목적
사용자가 안전하게 로그인/회원가입하고, 세션을 관리할 수 있는 완전한 인증 시스템을 구현합니다. 이는 프리미엄 콘텐츠 보호와 개인화된 사용자 경험의 기반이 됩니다.

### 배경
현재 NextAuth 설정은 있지만 실제 로그인 페이지가 없고, CredentialsProvider의 `authorize` 함수가 빈 구현 상태입니다. 사용자가 로그인할 방법이 전혀 없는 상태입니다.

### 범위

**포함사항:**
- 이메일/비밀번호 회원가입 페이지
- 이메일/비밀번호 로그인 페이지
- Google OAuth 소셜 로그인 (선택사항)
- 비밀번호 찾기/재설정 플로우
- 사용자 프로필 페이지 (기본 정보 표시)
- 세션 관리 및 자동 로그아웃
- 이메일 인증 (회원가입 시)

**제외사항:**
- 프로필 편집 기능 (향후 기능)
- 다중 인증(MFA/2FA)
- 소셜 로그인 다른 제공자 (Facebook, Twitter 등)
- 계정 삭제 기능 (GDPR 준수는 별도 구현)

## 사용자 시나리오

### 시나리오 1: 신규 사용자 회원가입

**사용자**: 처음 방문한 방문자
**상황**: "시작하기" 버튼 클릭

1. 사용자가 Header의 "시작하기" 또는 "로그인" 클릭
2. 로그인 페이지 표시, "계정이 없으신가요? 회원가입" 링크 보임
3. 회원가입 링크 클릭 → `/signup` 페이지로 이동
4. 회원가입 폼 입력:
   - 이메일 주소
   - 비밀번호 (최소 8자, 영문+숫자 조합)
   - 비밀번호 확인
   - 이름 (선택사항)
   - 이용약관 및 개인정보처리방침 동의 체크박스
5. "회원가입" 버튼 클릭
6. 시스템이 Supabase Auth에 사용자 생성:
   - 이메일 중복 확인
   - 비밀번호 해싱 (bcrypt)
   - `profiles` 테이블에 기본 정보 저장
7. 이메일 인증 메일 발송 (Supabase Auth 자동)
8. "이메일을 확인해주세요" 화면 표시
9. 사용자가 이메일의 인증 링크 클릭
10. 이메일 인증 완료 → 자동 로그인 → 홈페이지로 리다이렉트

### 시나리오 2: 기존 사용자 로그인

**사용자**: 이미 계정이 있는 사용자
**상황**: 로그인하여 프리미엄 콘텐츠 읽기

1. 사용자가 "로그인" 버튼 클릭
2. `/login` 페이지 표시:
   - 이메일 입력 필드
   - 비밀번호 입력 필드
   - "로그인 유지" 체크박스
   - "비밀번호를 잊으셨나요?" 링크
   - "로그인" 버튼
   - Google 로그인 버튼 (선택)
3. 이메일과 비밀번호 입력 후 "로그인" 클릭
4. 시스템이 Supabase Auth로 인증 요청
5. 인증 성공 시:
   - NextAuth 세션 생성
   - 원래 접근하려던 페이지로 리다이렉트 (또는 홈페이지)
6. 인증 실패 시:
   - "이메일 또는 비밀번호가 올바르지 않습니다" 오류 메시지
   - 폼 초기화 (비밀번호만 지움)

### 시나리오 3: Google OAuth 로그인

**사용자**: 빠른 로그인을 원하는 사용자
**상황**: Google 계정으로 간편 로그인

1. 로그인 페이지에서 "Google로 계속하기" 버튼 클릭
2. Google OAuth 팝업 열림
3. Google 계정 선택 및 권한 승인
4. CryptoTitan으로 리다이렉트
5. 시스템이 Google 프로필 정보 수신:
   - 이메일, 이름, 프로필 이미지
6. 첫 로그인인 경우:
   - Supabase에 사용자 자동 생성
   - `profiles` 테이블에 Google 정보 저장
7. NextAuth 세션 생성 → 홈페이지로 리다이렉트

### 시나리오 4: 비밀번호 찾기

**사용자**: 비밀번호를 잊어버린 사용자

1. 로그인 페이지에서 "비밀번호를 잊으셨나요?" 클릭
2. `/forgot-password` 페이지로 이동
3. 이메일 주소 입력 후 "재설정 링크 보내기" 클릭
4. 시스템이 Supabase Auth로 비밀번호 재설정 이메일 요청
5. "이메일을 확인해주세요" 메시지 표시
6. 사용자가 이메일의 재설정 링크 클릭
7. `/reset-password?token=xxx` 페이지로 이동
8. 새 비밀번호 입력 및 확인
9. "비밀번호 변경" 버튼 클릭
10. 비밀번호 업데이트 성공 → 로그인 페이지로 리다이렉트

### 시나리오 5: 자동 로그아웃

**사용자**: 로그인 상태 유지 체크하지 않은 사용자
**상황**: 브라우저 종료 후 재접속

1. 사용자가 "로그인 유지" 체크하지 않고 로그인
2. 브라우저를 닫음
3. NextAuth 세션 쿠키가 만료됨 (브라우저 세션)
4. 다시 사이트 방문 시 자동 로그아웃 상태
5. 프리미엄 콘텐츠 접근 시도 → 로그인 페이지로 리다이렉트

## 기능 요구사항

### FR1: 회원가입 페이지
- **설명**: 신규 사용자가 이메일/비밀번호로 계정을 생성할 수 있어야 함
- **입력 필드**:
  - 이메일 (필수, 이메일 형식 검증)
  - 비밀번호 (필수, 최소 8자, 영문+숫자 조합)
  - 비밀번호 확인 (필수, 비밀번호와 일치)
  - 이름 (선택, 최대 50자)
  - 이용약관 동의 (필수 체크박스)
- **검증 규칙**:
  - 이메일 중복 확인 (실시간 또는 제출 시)
  - 비밀번호 강도 표시기 (약함/보통/강함)
  - 모든 필수 필드 입력 시 버튼 활성화
- **성공 처리**:
  - Supabase Auth에 사용자 생성
  - 이메일 인증 메일 자동 발송
  - "이메일을 확인해주세요" 화면으로 전환

### FR2: 로그인 페이지
- **설명**: 기존 사용자가 이메일/비밀번호 또는 Google로 로그인할 수 있어야 함
- **입력 필드**:
  - 이메일 (필수)
  - 비밀번호 (필수)
  - "로그인 유지" 체크박스 (선택, 기본값: 체크됨)
- **인증 방식**:
  - 이메일/비밀번호: Supabase Auth 검증 (메인 인증 시스템)
  - Google OAuth: NextAuth GoogleProvider (OAuth 래퍼)
  - **아키텍처**: Supabase Auth가 Single Source of Truth, NextAuth는 세션 관리 및 OAuth만 담당
- **실패 처리**:
  - 명확한 오류 메시지 ("이메일 또는 비밀번호가 올바르지 않습니다")
  - Brute-force 방어: IP 기반 5회 또는 계정 기반 3회 실패 시 5분간 차단
- **성공 처리**:
  - Supabase 세션 + NextAuth 세션 동기화
  - 원래 URL로 리다이렉트 (또는 홈페이지)

### FR3: Google OAuth 통합
- **설명**: 사용자가 Google 계정으로 간편 로그인할 수 있어야 함
- **버튼 디자인**: Google 브랜드 가이드라인 준수
- **첫 로그인 처리**:
  - Google에서 받은 이메일, 이름, 프로필 이미지 자동 저장
  - `profiles.avatar_url`에 Google 프로필 이미지 URL 저장
- **기존 계정 연동**:
  - 동일 이메일이 이미 이메일/비밀번호로 가입된 경우 자동 연동
  - 사용자에게 "Google 계정이 연결되었습니다" 알림

### FR4: 비밀번호 재설정
- **설명**: 비밀번호를 잊은 사용자가 이메일로 재설정할 수 있어야 함
- **단계**:
  1. 이메일 입력 → Supabase Auth 재설정 메일 요청
  2. 이메일 링크 클릭 → 토큰 검증
  3. 새 비밀번호 입력 (동일한 강도 요구사항)
  4. 비밀번호 업데이트 → 로그인 페이지 리다이렉트
- **보안**:
  - 재설정 토큰 1시간 후 만료
  - 토큰은 1회만 사용 가능
  - 재설정 성공 시 모든 기존 세션 무효화

### FR5: 이메일 인증
- **설명**: 회원가입 시 이메일 소유권을 확인해야 함
- **프로세스**:
  - 회원가입 즉시 Supabase에서 인증 메일 발송
  - 사용자가 링크 클릭 → `email_confirmed` 플래그 true 설정
  - 미인증 상태에서 로그인 시 "이메일 인증이 필요합니다" 배너 표시
- **재발송**: "인증 메일 재발송" 버튼 제공 (1분 쿨다운)

### FR6: 세션 관리
- **설명**: 사용자 로그인 상태를 안전하게 유지하고 관리해야 함
- **세션 유형**:
  - "로그인 유지" 체크 시: 30일 유효
  - 체크 안 함: 브라우저 세션 (닫으면 만료)
- **자동 갱신**: 세션 만료 1시간 전 자동 연장 (사용자 활동 시)
- **로그아웃**: Header "로그아웃" 버튼 → 세션 삭제 → 홈페이지 리다이렉트

### FR7: 사용자 프로필 페이지
- **설명**: 로그인한 사용자가 자신의 프로필을 볼 수 있어야 함
- **표시 정보**:
  - 프로필 이미지 (Google OAuth 또는 기본 아바타)
  - 이름
  - 이메일 주소
  - 가입일
  - 구독 상태 (활성/비활성)
  - "구독 관리" 버튼 (활성 구독 시)
- **접근**: Header의 사용자 아이콘 클릭 → `/profile` 페이지

## 비기능 요구사항

### NFR1: 보안
- 비밀번호는 bcrypt로 해싱 (최소 10 라운드)
- 세션 토큰은 HttpOnly, Secure 쿠키로 전송
- CSRF 보호 (NextAuth 기본 제공)
- Rate limiting:
  - 동일 IP에서 로그인 실패 5회 → 5분간 차단
  - 동일 계정으로 로그인 실패 3회 → 5분간 차단
  - 둘 중 하나라도 충족되면 차단 적용

### NFR2: 성능
- 로그인 처리 시간 500ms 이내
- Google OAuth 리다이렉트 왕복 2초 이내
- 비밀번호 강도 체크 실시간 (타이핑 중)

### NFR3: 사용성
- 모든 폼 검증은 실시간 피드백 제공
- 오류 메시지는 구체적이고 도움이 되어야 함
- 비밀번호 입력 필드에 "보기/숨기기" 토글 아이콘
- 키보드 네비게이션 지원 (Tab, Enter)

### NFR4: 접근성
- WCAG 2.1 AA 준수
- 스크린 리더 호환 (aria-label 사용)
- 색상만으로 정보 전달하지 않음 (색맹 고려)

## 성공 기준

### 정량적 지표
1. **회원가입 완료율**: 회원가입 폼 진입 대비 완료율 60% 이상
2. **로그인 성공률**: 첫 시도 로그인 성공률 95% 이상
3. **이메일 인증률**: 회원가입 후 24시간 내 인증률 70% 이상
4. **비밀번호 재설정 성공률**: 재설정 요청 대비 완료율 80% 이상

### 정성적 지표
1. 사용자가 회원가입부터 로그인까지 3분 이내 완료 가능
2. 오류 메시지가 명확하여 사용자가 문제를 즉시 이해하고 해결 가능
3. Google OAuth 로그인이 이메일/비밀번호보다 빠르고 편리함

## 주요 엔티티

### User (Supabase Auth)
```
auth.users
├── id (uuid, PK)
├── email (text, unique)
├── encrypted_password (text)
├── email_confirmed_at (timestamptz)
├── last_sign_in_at (timestamptz)
├── created_at (timestamptz)
└── raw_user_meta_data (jsonb) -- name, avatar_url 등
```

### Profile (Supabase Public)
```
public.profiles
├── id (uuid, PK, FK → auth.users)
├── email (text)
├── name (text)
├── avatar_url (text)
├── bio (text, nullable)
├── created_at (timestamptz)
└── updated_at (timestamptz)
```

**Profile 자동 생성**: Supabase 트리거 함수로 `auth.users` 생성 시 `public.profiles` 자동 생성
```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, email, name, avatar_url)
  VALUES (
    NEW.id,
    NEW.email,
    NEW.raw_user_meta_data->>'name',
    NEW.raw_user_meta_data->>'avatar_url'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

## 테스트 시나리오

### 수용 테스트 1: 정상 회원가입
1. `/signup` 페이지 접속
2. 유효한 이메일, 강한 비밀번호, 일치하는 확인 비밀번호 입력
3. 이용약관 동의 체크
4. "회원가입" 클릭
5. **기대 결과**: "이메일을 확인해주세요" 화면 표시, 인증 메일 수신

### 수용 테스트 2: 중복 이메일 방어
1. 이미 가입된 이메일로 회원가입 시도
2. **기대 결과**: "이미 사용 중인 이메일입니다" 오류 메시지

### 수용 테스트 3: 정상 로그인
1. `/login` 페이지 접속
2. 가입된 이메일과 비밀번호 입력
3. "로그인" 클릭
4. **기대 결과**: 세션 생성, 홈페이지로 리다이렉트

### 수용 테스트 4: 잘못된 비밀번호
1. 올바른 이메일, 잘못된 비밀번호 입력
2. **기대 결과**: "이메일 또는 비밀번호가 올바르지 않습니다" 오류

### 수용 테스트 5: Google OAuth 로그인
1. "Google로 계속하기" 버튼 클릭
2. Google 계정 선택 및 승인
3. **기대 결과**: 자동 로그인, 프로필 정보 저장, 홈페이지 리다이렉트

### 수용 테스트 6: 비밀번호 재설정
1. "비밀번호를 잊으셨나요?" 클릭 → 이메일 입력
2. 이메일 링크 클릭 → 새 비밀번호 입력
3. **기대 결과**: 비밀번호 변경 성공, 새 비밀번호로 로그인 가능

### 수용 테스트 7: 세션 지속성
1. "로그인 유지" 체크하고 로그인
2. 브라우저 닫고 재실행
3. **기대 결과**: 여전히 로그인 상태 유지

## 엣지 케이스

### EC1: 이메일 인증 전 로그인 시도
- **상황**: 회원가입 후 이메일 인증 전에 로그인 시도
- **처리**: 로그인 허용하되, 페이지 상단에 "이메일 인증이 필요합니다. [재발송]" 배너 표시
- **복구**: 재발송 버튼 클릭 → 인증 메일 재전송 (1분 쿨다운)

### EC2: Google 이메일과 기존 계정 충돌
- **상황**: Google 이메일이 이미 이메일/비밀번호로 가입됨
- **처리**: 자동 계정 연동, "Google 계정이 연결되었습니다" 알림
- **복구**: 이후 Google 또는 이메일/비밀번호 둘 다 로그인 가능

### EC3: 다중 탭 로그아웃
- **상황**: 여러 탭에서 로그인 상태, 한 탭에서 로그아웃
- **처리**: 모든 탭의 세션 무효화 (NextAuth 이벤트 동기화)
- **복구**: 다른 탭 새로고침 시 자동 로그아웃 상태 반영

### EC4: 만료된 재설정 토큰
- **상황**: 비밀번호 재설정 링크가 1시간 경과
- **처리**: "링크가 만료되었습니다" 오류, 재요청 버튼 표시
- **복구**: 재요청 → 새 이메일 발송

### EC5: 브루트포스 공격
- **상황**: 동일 IP에서 5회 연속 로그인 실패
- **처리**: 해당 IP 5분간 로그인 차단
- **복구**: 5분 후 자동 해제, 또는 "비밀번호 찾기"로 우회

## 가정사항

1. **이메일 전달성**: Supabase 이메일 서비스가 95% 이상 전달률 보장
2. **Google OAuth 가용성**: Google OAuth가 99.9% 가동률 유지
3. **사용자 브라우저**: 쿠키 활성화, JavaScript 활성화
4. **이메일 접근**: 사용자가 가입 이메일에 접근 가능
5. **개인정보 동의**: 한국 개인정보보호법 준수 (명시적 동의 필수)

## 종속성

### 외부 종속성
- **Supabase Auth**: 사용자 인증 및 세션 관리
- **NextAuth**: OAuth 통합 및 세션 미들웨어
- **Google OAuth**: Google 로그인 제공
- **Resend/Supabase Email**: 이메일 발송

### 내부 종속성
- **프로필 DB**: `profiles` 테이블 존재 필요
- **환경 변수**: `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `NEXTAUTH_SECRET`

## 제약사항

### 기술 제약
- NextAuth v4 사용 (v5는 아직 안정화 전)
- **Supabase Auth가 메인 인증 시스템** (RLS 정책 통합)
- NextAuth는 OAuth 및 Next.js 세션 관리만 담당
- 비밀번호 정책은 Supabase 기본값 준수
- 세션 동기화: Supabase JWT를 NextAuth 세션에 포함

### 비즈니스 제약
- 미성년자 가입 불가 (이용약관에 명시)
- 한국 거주자 대상 (개인정보처리방침 한국법 기준)
- Google OAuth만 지원 (추가 제공자는 향후 검토)

## 위험 요소

### 높은 위험
- **이메일 스팸 처리**: 인증 메일이 스팸함으로 가는 경우
  - **완화**: Supabase 도메인 인증(SPF/DKIM) 설정
- **세션 하이재킹**: XSS 공격으로 세션 탈취
  - **완화**: HttpOnly 쿠키, CSP 헤더, 입력 검증

### 중간 위험
- **Google OAuth 장애**: Google 서비스 다운 시 로그인 불가
  - **완화**: 이메일/비밀번호 대체 수단 항상 제공
- **비밀번호 재사용**: 사용자가 약한 비밀번호 사용
  - **완화**: 비밀번호 강도 체커, 최소 요구사항 강제

## 관련 문서

- [CryptoTitan 헌장 - 원칙 6](../../memory/constitution.md#원칙-6-보안-및-개인정보-보호)
- [NextAuth 문서](https://next-auth.js.org)
- [Supabase Auth 가이드](https://supabase.com/docs/guides/auth)

---

**다음 단계**: 이 명세서를 `/speckit.clarify`로 검토 후, `/speckit.plan`으로 구현 계획 수립
